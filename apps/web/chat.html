<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ADHD Assistant â€” Chat</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #0f1630;
      --panel-2: #131a33;
      --text: #e9ecf8;
      --muted: #a7b0d9;
      --brand: #5a7bff;
      --ring: #2b3a6d;
      --border: #1b2547;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(60% 80% at 70% 10%, #10183a 0%, #0b1020 50%);
      color: var(--text);
      font: 16px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      position: sticky; top: 0;
      backdrop-filter: blur(8px);
      background: rgb(11 16 32 / .6);
      border-bottom: 1px solid var(--border);
    }
    .bar {
      max-width: 1024px; margin: 0 auto;
      padding: 16px 20px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .brand { font-weight: 700; letter-spacing: .3px; }
    .who { color: var(--muted); font-size: 14px; }
    .wrap {
      flex: 1;
      max-width: 1024px; margin: 0 auto; padding: 20px;
      display: flex; flex-direction: column;
    }
    .panel {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      flex: 1;
      display: flex; flex-direction: column;
    }
    .messages {
      flex: 1; overflow-y: auto; padding: 6px 8px;
      display: flex; flex-direction: column; gap: 10px;
    }
    .msg {
      max-width: 72%;
      padding: 10px 14px;
      border-radius: 14px;
      white-space: pre-wrap;
      box-shadow: inset 0 0 0 1px #0000001a;
    }
    .me  { align-self: flex-start; background: #1a2550; }
    .bot { align-self: flex-end; background: #3b82f6; color: #fff; }
    .meta { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .cites { font-size: 12px; color: var(--muted); margin: 6px 0 0 2px; }
    .suggest {
      display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 2px 12px;
    }
    .suggest button {
      padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border);
      background: #111739; color: var(--text); cursor: pointer;
    }
    .suggest button:hover { border-color: var(--brand); }

    .composer {
      position: sticky; bottom: 0;
      background: rgb(11 16 32 / .7);
      backdrop-filter: blur(10px);
      padding: 10px 20px;
      border-top: 1px solid var(--border);
    }
    .compose {
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 1024px;
      margin: 0 auto;
    }
    #txt {
      flex: 1;
      padding: 10px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: #0c1430;
      color: var(--text);
      font-size: 14px;
      outline: none;
      resize: none;
      height: 40px;
    }
    #txt:focus { border-color: var(--ring); box-shadow: 0 0 0 2px rgb(90 123 255 / .25); }
    .send {
      width: 40px; height: 40px;
      border-radius: 50%;
      border: none;
      background: #3b82f6;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: background .2s;
    }
    .send:hover { background: #2563eb; }
    .send svg { fill: white; width: 20px; height: 20px; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">ADHD Assistant</div>
      <div class="who" id="who"></div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div id="messages" class="messages"></div>
      <div class="suggest" id="suggest"></div>
    </section>
  </main>

  <div class="composer">
    <div class="compose">
      <input type="text" id="txt" placeholder="Write a message" />
      <button class="send" id="send">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
        </svg>
      </button>
    </div>
  </div>

  <script>
    const $ = (q)=>document.querySelector(q);
    const api = "http://localhost:8000";
    const patient_id = localStorage.getItem("patient_id");
    const patient_display = localStorage.getItem("patient_display") || patient_id;
    if (!patient_id) location.href = "index.html";
    $("#who").textContent = "Signed in as " + (patient_display || patient_id);

    const starters = [
      "What is ADHD?",
      "How can I stay focused at work?",
      "Tips for improving relationships",
      "How do I start tasks when I feel stuck?"
    ];

    function add(role, text) {
      const wrap = document.createElement("div");
      wrap.className = "msg " + (role === "user" ? "me" : "bot");
      wrap.textContent = text;
      $("#messages").appendChild(wrap);
      $("#messages").scrollTop = $("#messages").scrollHeight;
    }

    function addCites(cites) {
      if (!cites || !cites.length) return;
      const d = document.createElement("div");
      d.className = "cites";
      d.innerHTML = "<b>Citations:</b> " + cites.map(c => "[" + c.title + "]").join(" ");
      $("#messages").appendChild(d);
    }

    function initStarters() {
      const s = $("#suggest");
      starters.forEach(q => {
        const b = document.createElement("button");
        b.textContent = q;
        b.onclick = () => { $("#txt").value = q; send(); };
        s.appendChild(b);
      });
    }

    async function send() {
      const msg = $("#txt").value.trim();
      if (!msg) return;
      $("#txt").value = "";
      add("user", msg);
      try {
        const r = await fetch(api + "/v1/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ patient_id, message: msg })
        });
        const data = await r.json();
        add("assistant", data.reply || "[no reply]");
        addCites(data.cites);
      } catch (err) {
        console.error(err);
        add("assistant", "[error connecting to server]");
      }
    }

    $("#send").onclick = send;
    $("#txt").addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault(); send();
      }
    });

    initStarters();
  </script>
</body>
</html>
